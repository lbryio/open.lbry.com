<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>LBRY Redirect</title>
    <link rel="stylesheet" href="reset.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lbryio/components@master/dist/index.css"/>
    <style>
      body {
        background-color: var(--lbry-cyan-5);
        background-image: linear-gradient(to bottom right, var(--lbry-teal-5), var(--lbry-cyan-5) 100%);
        color: var(--lbry-white);
      }

      section {
        text-align: center;
        display: block;
      }

      section h1 {
        font-size: 200%;
      }

      section.container{
        border-radius: 2px;
        max-width: 500px;
        background-color: var(--lbry-white);
        color: black;
        height: 400px;
        display: flex;
        flex-direction: column;
        margin: auto;
        display: flex;
        flex-direction: column;
        justify-content: space-evenly;
        align-items: center;
        padding: 2rem;
      }

      div.control-container {
        display: flex;
        flex-direction: row;
        margin: 0;
        flex-wrap: no-wrap;
        justify-content: space-around;
        width: 100%;
      }
      div.control-element {
        margin: 5px;
        width: 100%;

      }

      .hidden {
        display: none;
      }

      a, button{
        color: var(--lbry-black);
        font-size: 1.2rem;
        padding: 0.2rem 0.5rem;
        text-decoration: none;
        box-sizing: border-box;
        width: 100%;
        height: 120px;
      }
    </style>
  </head>

  <body>
    <section class="container">
      <h1 id="countdown">Sending you to <span id="dest"></span> in <span id="timer"></span></h1>
      <h1 id="chooseWeapon" class="hidden">Choose your weapon...</h1>
      <div class="control-container">
        <div class="control-element">
          <button class="button--primary" id="appButton">LBRY App</button>
        </div>
        <div class="control-element" id="stopDiv">
          <button class="button--primary" id="stopButton">Stop!</button>
        </div>
        <div class="control-element">
          <button class="button--primary" id="webButton">LBRY.tv (beta)</button>
        </div>
      </div>
      <div class="control-element">
        <div class="checkbox-element">
          <input id="remember" name="remember" type="checkbox">
          <label for="remember">Always do this</label>
          <div class="checkbox-toggle"></div>
        </div>
      </div>
      <p>If you do not have the LBRY app, you can <a class="button--primary" href="https://lbry.com/get" rel="noopener noreferrer" target="_blank">download it here</a></p>
    </section>
  </body>

  <script>
    (function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga");
    ga("create", "UA-60403362-9", "auto");
    ga("send", "pageview");
    const WEB_BUTTON = "webButton";
    const APP_BUTTON = "appButton";
    const TV_PREFIX = "https://beta.lbry.tv/";
    const APP_PREFIX = "lbry://";
    const LBRY_TARGET = "lbrytarget";

    let site = window.location.protocol + "//" + window.location.host;
    let url = decodeURIComponent(window.location.href.replace(site,"").replace(/^\//,""));

    (function  letsGo() {

      let go = true;
      let storedDest = localStorage.getItem(LBRY_TARGET); //webButton or appButton

      let prefix = TV_PREFIX;

      // elements
      const dest = document.getElementById("dest");
      const timer = document.getElementById("timer");
      const appButton = document.getElementById("appButton");
      const webButton = document.getElementById("webButton");
      const rememberBox = document.getElementById("remember");
      const stopButton = document.getElementById("stopButton");
      const stopDiv = document.getElementById("stopDiv");
      const countdown = document.getElementById("countdown");
      const chooseWeapon = document.getElementById("chooseWeapon");

      // event listeners
      appButton.addEventListener("click", handleChoice);
      webButton.addEventListener("click", handleChoice);
      stopButton.addEventListener("click", stop);
      rememberBox.addEventListener("click", handleRemember);

      dest.innerHTML = "LBRY.tv";

      if (storedDest) {
        rememberBox.checked = true;
        if (storedDest === WEB_BUTTON) {
          dest.innerHTML = "LBRY.tv";
          prefix = TV_PREFIX;
        } else if (storedDest === APP_BUTTON) {
          dest.innerHTML = "your LBRY App";
          prefix = APP_PREFIX;
        } else {
          localStorage.clear();
        }
      }

      function handleRemember() {
        stop();
        !rememberBox.checked && localStorage.removeItem(LBRY_TARGET);
      }

      function handleChoice(event) {
        stop();
        let choice = event.target.id;
        prefix = (choice === APP_BUTTON) ? APP_PREFIX : TV_PREFIX;
        if (rememberBox.checked) {
          localStorage.setItem(LBRY_TARGET, choice);
        }
        goToLbry();
      }

      function stop() {
        stopDiv.classList.add("hidden");
        chooseWeapon.classList.remove("hidden");
        countdown.classList.add("hidden");
        go = false;
      }

      function goToLbry() {
        window.location = prefix + url;
      }

      function countDown(time) {
        let count = time;
        if (go) {
          if (count > 0) {
              count--;
              timer.innerHTML = " "+time+" ";
              return setTimeout(() => {countDown(count)}, 1000);
          } else {
            goToLbry()
          }
        }
        return
      }

      if (storedDest){
        countDown(2);
      } else {
        countDown(5);
      }

    })();

  </script>
</html>
